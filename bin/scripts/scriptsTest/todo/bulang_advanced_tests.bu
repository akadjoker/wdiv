// ============================================
// BULANG ADVANCED FEATURES TEST SUITE
// ============================================
// Test processes, fibers, gosub/goto, etc.

print("========================================");
print("  BULANG ADVANCED FEATURES TEST SUITE");
print("========================================\n");

var totalTests = 0;
var passedTests = 0;

def assert(condition, message) {
    totalTests = totalTests + 1;
    if (condition) {
        passedTests = passedTests + 1;
        print("âœ… " + message);
    } else {
        print("âŒ FAILED: " + message);
    }
}

// ============================================
// TEST 1: PROCESS BASICS
// ============================================
print("\n[TEST 1] Process Basics");

var processResult = 0;

process testProcess(x, y) {
    processResult = x + y;
}

// Spawn process
var pid = testProcess(10, 20);
frame(5);  // Wait for process to execute
assert(processResult == 30, "Process executes with args");

// ============================================
// TEST 2: PROCESS PRIVATE VARIABLES
// ============================================
print("\n[TEST 2] Process Private Variables");

var sharedCounter = 0;

process counter(increment) {
    var count = 0;
    loop {
        count = count + increment;
        sharedCounter = count;
        frame(10);
        if (count >= 10) break;
    }
}

counter(2);
frame(30);
assert(sharedCounter == 10, "Process private variables");

// ============================================
// TEST 3: MULTIPLE PROCESSES
// ============================================
print("\n[TEST 3] Multiple Processes");

var process1Done = false;
var process2Done = false;

process proc1() {
    var i = 0;
    loop {
        i = i + 1;
        frame;
        if (i >= 5) {
            process1Done = true;
            break;
        }
    }
}

process proc2() {
    var i = 0;
    loop {
        i = i + 1;
        frame;
        if (i >= 5) {
            process2Done = true;
            break;
        }
    }
}

proc1();
proc2();
frame(10);

assert(process1Done, "Process 1 completes");
assert(process2Done, "Process 2 completes");

// ============================================
// TEST 4: PROCESS COMMUNICATION
// ============================================
print("\n[TEST 4] Process Communication");

var messageBox = 0;

process sender() {
    frame(5);
    messageBox = 42;
}

process receiver() {
    loop {
        frame;
        if (messageBox == 42) {
            messageBox = 100;
            break;
        }
    }
}

sender();
receiver();
frame(20);

assert(messageBox == 100, "Processes communicate via globals");

// ============================================
// TEST 5: GOSUB/RETURN
// ============================================
print("\n[TEST 5] Gosub/Return");

var gosubResult = 0;

process gosubTest() {
    gosubResult = 1;
    gosub subroutine;
    gosubResult = gosubResult + 10;
    goto end;
    
subroutine:
    gosubResult = gosubResult + 5;
    return;
    
end:
}

gosubTest();
frame(5);
assert(gosubResult == 16, "Gosub/return works (1 + 5 + 10)");

// ============================================
// TEST 6: GOTO FORWARD
// ============================================
print("\n[TEST 6] Goto Forward");

var gotoResult = 0;

process gotoTest() {
    gotoResult = 1;
    goto skip;
    gotoResult = 999;  // Should be skipped
skip:
    gotoResult = gotoResult + 10;
}

gotoTest();
frame(5);
assert(gotoResult == 11, "Goto skips code");

// ============================================
// TEST 7: GOTO LOOP
// ============================================
print("\n[TEST 7] Goto Loop");

var loopCount = 0;

process gotoLoop() {
start:
    loopCount = loopCount + 1;
    frame;
    if (loopCount < 5) goto start;
}

gotoLoop();
frame(10);
assert(loopCount == 5, "Goto creates loop");

// ============================================
// TEST 8: NESTED GOSUB
// ============================================
print("\n[TEST 8] Nested Gosub");

var nestedResult = 0;

process nestedGosub() {
    nestedResult = 1;
    gosub sub1;
    nestedResult = nestedResult + 100;
    goto finish;

sub1:
    nestedResult = nestedResult + 10;
    gosub sub2;
    nestedResult = nestedResult + 20;
    return;

sub2:
    nestedResult = nestedResult + 30;
    return;

finish:
}

nestedGosub();
frame(5);
assert(nestedResult == 161, "Nested gosub (1+10+30+20+100)");

// ============================================
// TEST 9: PROCESS WITH STRUCT
// ============================================
print("\n[TEST 9] Process with Struct");

struct Position {
    x, y
};

var finalPos = nil;

process mover() {
    var pos = Position(0, 0);
    loop {
        pos.x = pos.x + 1;
        pos.y = pos.y + 2;
        frame;
        if (pos.x >= 5) {
            finalPos = pos;
            break;
        }
    }
}

mover();
frame(10);
assert(finalPos.x == 5, "Process modifies struct x");
assert(finalPos.y == 10, "Process modifies struct y");

// ============================================
// TEST 10: PROCESS LIFETIME
// ============================================
print("\n[TEST 10] Process Lifetime");

var lifecycleState = 0;

process lifecycle() {
    lifecycleState = 1;  // Started
    frame(5);
    lifecycleState = 2;  // Running
    frame(5);
    lifecycleState = 3;  // Done
}

lifecycle();
assert(lifecycleState == 1, "Process starts");
frame(7);
assert(lifecycleState == 2, "Process continues");
frame(7);
assert(lifecycleState == 3, "Process completes");

// ============================================
// TEST 11: MANY PROCESSES SPAWN
// ============================================
print("\n[TEST 11] Many Processes Spawn");

var spawnCount = 0;

process spawner() {
    spawnCount = spawnCount + 1;
}

for (var i = 0; i < 100; i++) {
    spawner();
}

frame(5);
assert(spawnCount == 100, "100 processes spawned");

// ============================================
// TEST 12: PROCESS WITH RECURSION
// ============================================
print("\n[TEST 12] Process with Recursion");

var recursiveSum = 0;

def recursiveAdd(n) {
    if (n <= 0) return 0;
    return n + recursiveAdd(n - 1);
}

process recursiveProc() {
    recursiveSum = recursiveAdd(10);
}

recursiveProc();
frame(5);
assert(recursiveSum == 55, "Process calls recursive function");

// ============================================
// TEST 13: PROCESS WITH CLASSES
// ============================================
print("\n[TEST 13] Process with Classes");

class Entity {
    var health;
    
    def init(h) {
        self.health = h;
    }
    
    def damage(amount) {
        self.health = self.health - amount;
    }
}

var entityHealth = 0;

process entityProc() {
    var e = Entity(100);
    e.damage(25);
    frame;
    e.damage(25);
    entityHealth = e.health;
}

entityProc();
frame(5);
assert(entityHealth == 50, "Process uses classes");

// ============================================
// TEST 14: FRAME TIMING
// ============================================
print("\n[TEST 14] Frame Timing");

var frameCounter = 0;

process frameTiming() {
    frameCounter = 1;
    frame(10);  // Wait 10 frames
    frameCounter = 2;
}

frameTiming();
frame(5);
assert(frameCounter == 1, "Before frame(10) completes");
frame(10);
assert(frameCounter == 2, "After frame(10) completes");

// ============================================
// TEST 15: PROCESS INDEPENDENCE
// ============================================
print("\n[TEST 15] Process Independence");

var result1 = 0;
var result2 = 0;

process independent1() {
    var localVar = 10;
    frame;
    result1 = localVar * 2;
}

process independent2() {
    var localVar = 20;
    frame;
    result2 = localVar * 3;
}

independent1();
independent2();
frame(5);

assert(result1 == 20, "Process 1 has own locals");
assert(result2 == 60, "Process 2 has own locals");

// ============================================
// FINAL REPORT
// ============================================
print("\n========================================");
print("         ADVANCED TEST RESULTS");
print("========================================");
print("Total Tests: " + totalTests);
print("Passed:      " + passedTests);
print("Failed:      " + (totalTests - passedTests));

if (totalTests == passedTests) {
    print("\nðŸŽ‰ ALL ADVANCED TESTS PASSED! ðŸŽ‰");
    print("Processes, gosub/goto, and fibers are SOLID!");
} else {
    print("\nâš ï¸  SOME ADVANCED TESTS FAILED");
    print("Review process/fiber implementation!");
}
print("========================================\n");
